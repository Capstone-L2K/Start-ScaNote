# íŒŒì´ì¬ OpenCVë¥¼ í†µí•œ ë„í˜•ê²€ì¶œ

íŠ¹ì • ì´ë¯¸ì§€ì—ì„œ ì ,ì„ ,ì‚¼ê°í˜•,ì‚¬ê°í˜• ë“±ì˜  ê°ì¢… ë„í˜•ë“¤ì„ ê²€ì¶œí•˜ê¸° ìœ„í•´ì„œ Python Open CVë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. Open CVë¥¼ í†µí•´ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ì™¸ê³½ì„ ì„ ê²€ì¶œí•˜ì—¬ ê¼­ì§€ì ì„ êµ¬í•œ í›„, **ê¼­ì§“ì  ê°œìˆ˜**ë¥¼ í†µí•´ ì–´ë–¤ ë„í˜•ì¸ì§€ ì‹ë³„í•©ë‹ˆë‹¤.

## Open CV ì„¤ì¹˜

: OpenCV ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ê´€ë ¨ ëª¨ë“ˆì„ ì„¤ì¹˜í•´ì•¼í•©ë‹ˆë‹¤.

- ì„¤ì¹˜

```bash
pip install opencv-python
```

- ì„¤ì¹˜ í™•ì¸

```python
import cv2

print(cv2.__version__)

# ì‹¤í–‰ ê²°ê³¼ 
4.6.0
```



### ìŠ¤ë ˆì‹œí™€ë”©(Thresholding)

: ìŠ¤ë ˆì‹œí™€ë”©ì€ ë°”ì´ë„ˆë¦¬ ì´ë¯¸ì§€ë¥¼ ë§Œë“œëŠ” ê°€ì¥ ëŒ€í‘œì ì¸ ë°©ë²•ì…ë‹ˆë‹¤. ë°”ì´ë„ˆë¦¬ ì´ë¯¸ì§€(binary image)ë€ ê²€ì€ìƒ‰ê³¼ í°ìƒ‰ë§Œìœ¼ë¡œ í‘œí˜„í•œ ì´ë¯¸ì§€ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.Â ìŠ¤ë ˆì‹œí™€ë”©ì´ë€ ì—¬ëŸ¬ ê°’ì„ ì–´ë–¤ ì„ê³„ì ì„ ê¸°ì¤€ìœ¼ë¡œ ë‘ ê°€ì§€ ë¶€ë¥˜ë¡œ ë‚˜ëˆ„ëŠ” ë°©ë²•ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

[OpenCV - 8. ìŠ¤ë ˆì‹œí™€ë”©(Thresholding), ì˜¤ì¸ ì˜ ì•Œê³ ë¦¬ì¦˜(Otsu's Method)](https://bkshin.tistory.com/entry/OpenCV-8-%EC%8A%A4%EB%A0%88%EC%8B%9C%ED%99%80%EB%94%A9Thresholding)

ì´ì§„í™”ì‹œí‚¨ ì´ë¯¸ì§€ì—ì„œ findContoursí•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ contourë¥¼ ì°¾ì€ í›„, approxPolyDP í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¤ê°í˜•(polygon)ì„ ê²€ì¶œí•©ë‹ˆë‹¤.

## ì´ë¯¸ì§€ ì „ì²˜ë¦¬

- ì›ë³¸ ì´ë¯¸ì§€

![image](https://user-images.githubusercontent.com/86418674/206462395-72a97803-78a0-4309-a385-45ad33f4b979.png)


: ë‹¤ìŒ í…ŒìŠ¤íŠ¸ìš© ì´ë¯¸ì§€ë¥¼ ì €ì¥í•˜ì—¬ OpenCVë¥¼ ìœ„í•œ í”„ë¡œì íŠ¸ í´ë”ì— ë„£ìŠµë‹ˆë‹¤.

- ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°

```python
path = os.path.join('img','sample.jpg') # img ëŠ” í´ë”ëª…, sample.jpgëŠ” í…ŒìŠ¤íŠ¸í•  ì‚¬ì§„ëª…
img_color = cv.imread(path, cv.IMREAD_COLOR)
```

OpenCV ëŠ” **ê²€ì€ìƒ‰ ë°°ê²½ì— í°ìƒ‰ ê°ì²´ë¥¼ ì‹ë³„**í•˜ì—¬ ê²€ì¶œí•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì´ë¯¸ì§€ ìƒ‰ìƒì„ ë°˜ì „í•˜ê³  ì•„ë˜ì²˜ëŸ¼ ë¿Œì˜‡ê±°ë‚˜ ëª…ì•”ì´ ì •í™•í•˜ì§€ ì•Šì€ ì‚¬ì§„ì˜ ê²½ìš°ì—ëŠ” ìŠ¤ë ˆì‹œí™€ë”©ì„ í†µí•´ ë„í˜•ì„ ì •í™•íˆ ê²€ì¶œí•  ìˆ˜ ìˆë„ë¡ ìµœì í™”ëœ ë°”ì´ë„ˆë¦¬ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. 


- ê·¸ë ˆì´ ìŠ¤ì¼€ì¼ë¡œ ë³€í™˜

```python
img = cv2.imread(path)
img_gray = cv.cvtColor(img_color, cv.COLOR_BGR2GRAY)
```

: ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ê·¸ë ˆì´ ìŠ¤ì¼€ì¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.

**[ê²°ê³¼]**

![image](https://user-images.githubusercontent.com/86418674/206462446-ccb99cd3-4b77-4840-ace0-ec94ebb9da81.png)



- ì´ì§„í™”

```python
ret,img_binary = cv.threshold(img_gray, 127, 255, cv.THRESH_BINARY_INV|cv.THRESH_OTSU)
```

:  ì»¨íˆ¬ì–´ë¥¼ ê²€ì¶œí•  ë„í˜•ì´ í°ìƒ‰ì˜ì—­ì´ ë˜ê³  ë°°ê²½ì€ ê²€ì€ìƒ‰ì´ ë˜ë„ë¡ ìƒ‰ìƒì„ ë°˜ì „í•©ë‹ˆë‹¤.

**[ê²°ê³¼]**
![image](https://user-images.githubusercontent.com/86418674/206462494-9ac2da56-8d26-452e-b4e1-cb63db361f3f.png)


## ë„í˜• ì™¸ê³½ì„  ê²€ì¶œ

```python
contours, hierarchy = cv.findContours(img_binary, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE)
```

: `findContours` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°”ì´ë„ˆë¦¬ ì´ë¯¸ì§€ì—ì„œ ì™¸ê³½ì„ ì„ ê²€ì¶œí•©ë‹ˆë‹¤. `cv.RETR_EXTERNAL` ì˜µì…˜ì„ ì£¼ì–´ ì™¸ê³½ì— ìˆëŠ” ì»¨íˆ¬ì–´ë§Œ ê²€ì¶œí•˜ë„ë¡ í•©ë‹ˆë‹¤. `CHAIN_APPROX_SIMPLE` ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ ê²€ì¶œë˜ëŠ” ì»¨íˆ¬ì–´ì˜ êµ¬ì„±ì  ê°œìˆ˜ë¥¼ ì¤„ì—¬ì¤ë‹ˆë‹¤. ì˜ˆë¥¼ë“¤ì–´ ì§ì„  ë¶€ë¶„ì´ ìˆìœ¼ë©´ ì–‘ ëì ë§Œ ì €ì¥í•©ë‹ˆë‹¤.

<aside>
ğŸ“Œ **cv2.findContours(image, mode, method, contours=None, hierarchy=None, offset=None) -> contours, hierarchy**

- image: ì…ë ¥ ì˜ìƒ. non-zero í”½ì…€ì„ ê°ì²´ë¡œ ê°„ì£¼í•¨.
- mode: ì™¸ê³½ì„  ê²€ì¶œ ëª¨ë“œ. cv2.RETR_ë¡œ ì‹œì‘í•˜ëŠ” ìƒìˆ˜.
- method: ì™¸ê³½ì„  ê·¼ì‚¬í™” ë°©ë²•. cv2.CHAIN_APPROX_ë¡œ ì‹œì‘í•˜ëŠ” ìƒìˆ˜.
- contours: ê²€ì¶œëœ ì™¸ê³½ì„  ì¢Œí‘œ. numpy.ndarrayë¡œ êµ¬ì„±ëœ ë¦¬ìŠ¤íŠ¸. len(contours)=ì „ì²´ ì™¸ê³½ì„  ê°œìˆ˜(N). contours[i].shape=(K, 1, 2). contours[i].dtype=numpy.int32.
- hierarchy: ì™¸ê³½ì„  ê³„ì¸µ ì •ë³´. numpy.ndarray. shape=(1, N, 4). dtype=numpy.int32. hierarchy[0, i, 0] ~ hierarchy[0, i, 3]ì´ ìˆœì„œëŒ€ë¡œ next, prev, child, parent ì™¸ê³½ì„  ì¸ë±ìŠ¤ë¥¼ ê°€ë¦¬í‚´. í•´ë‹¹ ì™¸ê³½ì„ ì´ ì—†ìœ¼ë©´ -1.
- offset: ì¢Œí‘œ ê°’ ì´ë™ ì˜µì…‹. ê¸°ë³¸ê°’ì€ (0, 0).
</aside>

```python
for cnt in contours:
    size = len(cnt)
    print(size)

    epsilon = 0.005 * cv.arcLength(cnt, True)
    approx = cv.approxPolyDP(cnt, epsilon, True) # ì»¨íˆ¬ì–´ë¥¼ ì§ì„ ìœ¼ë¡œ ê·¼ì‚¬í™”

    size = len(approx) #ê·¼ì‚¬í™” ì‹œí‚¨ í›„ ì»¨íˆ¬ì–´ë¥¼ êµ¬ì„±í•˜ëŠ” ì„±ë¶„ì˜ ê°œìˆ˜
   
   # ì§ì„ ìœ¼ë¡œ ê·¼ì‚¬í™”ëœ ì»¨íˆ¬ì–´ë¥¼ ì…ë ¥ ì´ë¯¸ì§€ì— ê·¸ë¦°ë‹¤.
    cv.line(img_color, tuple(approx[0][0]), tuple(approx[size-1][0]), (0, 255, 0), 3)
    for k in range(size-1):
        cv.line(img_color, tuple(approx[k][0]), tuple(approx[k+1][0]), (0, 255, 0), 3)
```

: ê²€ì¶œëœ ì»¨íˆ¬ì–´ë¥¼ ì§ì„ ìœ¼ë¡œ ê·¼ì‚¬í™” ì‹œí‚µë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ìš°ì„  forë¬¸ì„ ì‚¬ìš©í•˜ì—¬ ì»¨íˆ¬ì–´ë¦¬ìŠ¤íŠ¸ì—ì„œ ì»¨íˆ¬ì–´ë¥¼ í•˜ë‚˜ì”© êº¼ëƒ…ë‹ˆë‹¤. `approxPolyDP` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì»¨íˆ¬ì–´ë¥¼ ì§ì„ ìœ¼ë¡œ ê·¼ì‚¬í™”í•˜ê³ , ì§ì„ ìœ¼ë¡œ ê·¼ì‚¬í™”ëœ ì»¨íˆ¬ì–´ë¥¼ ì…ë ¥ì´ë¯¸ì§€ì— ê·¸ë ¤ì¤ë‹ˆë‹¤.


**[ê²°ê³¼]**

: ë„í˜• ì£¼ë³€ì— ë…¹ìƒ‰ì„ (ì»¨íˆ¬ì–´)ì´ ê·¸ë ¤ì§‘ë‹ˆë‹¤.
![image](https://user-images.githubusercontent.com/86418674/206462722-eda202c7-5dc7-4667-bbe9-38c6da295482.png)

- ë¼ë²¨ë§

```python
# ì»¨íˆ¬ì–´ ì˜ì—­ë‚´ì— í…ìŠ¤íŠ¸ ì¶œë ¥
def setLabel(image, str, contour):
    (text_width, text_height), baseline = cv.getTextSize(str, cv.FONT_HERSHEY_SIMPLEX, 0.7, 1)
    
    # ì£¼ì–´ì§„ ë¬¸ìì—´ ì™¸ê³½ì„ ë‘˜ëŸ¬ìŒ€ ìˆ˜ ìˆëŠ” ë°•ìŠ¤ì˜ ë„ˆë¹„ì™€ ë†’ì´ë¥¼ ê³„ì‚°
    x,y,width,height = cv.boundingRect(contour)
    
    # ì»¨íˆ¬ì–´ ì™¸ê³½ì„ ë‘˜ëŸ¬ì‹¸ëŠ” ë°•ìŠ¤ì˜ ì • ì¤‘ì•™ì— í…ìŠ¤íŠ¸ì™€ í…ìŠ¤íŠ¸ ë°•ìŠ¤ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.
    pt_x = x+int((width-text_width)/2)
    pt_y = y+int((height + text_height)/2)
    cv.rectangle(image, (pt_x, pt_y+baseline), (pt_x+text_width, pt_y-text_height), (200,200,200), cv.FILLED)
    cv.putText(image, str, (pt_x, pt_y), cv.FONT_HERSHEY_SIMPLEX, 0.7, (0,0,0), 1, 8)
```

:  ë„í˜•ì´ ì˜ êµ¬ë³„ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê¸°ìœ„í•´ì„œ ì»¨íˆ¬ì–´ ì˜ì—­ë‚´ì— í…ìŠ¤íŠ¸ë¥¼ ì¶œë ¥í•˜ëŠ” setLabel í•¨ìˆ˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. `cv.boundingRect` ë¥¼ í†µí•´ ì£¼ì–´ì§„ ë¬¸ìì—´ ì™¸ê³½ì„ ë‘˜ëŸ¬ìŒ€ ìˆ˜ ìˆëŠ” ë°•ìŠ¤ì˜ ë„ˆë¹„ì™€ ë†’ì´ë¥¼ ê³„ì‚°í•˜ê³  ì»¨íˆ¬ì–´ ì™¸ê³½ì„ ë‘˜ëŸ¬ì‹¸ëŠ” ë°•ìŠ¤ì˜ ì • ì¤‘ì•™ì— í…ìŠ¤íŠ¸ì™€ í…ìŠ¤íŠ¸ ë°•ìŠ¤ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.


ğŸ“Œ **cv2.boundingRect**
: contourì— ì™¸ì ‘í•˜ëŠ” ë˜‘ë°”ë¡œ ì„¸ì›Œì§„ ì‚¬ê°í˜•ì„ ì–»ê¸° ìœ„í•´ cv2.boundingRect() í•¨ìˆ˜ë¥¼ ì´ìš©í•©ë‹ˆë‹¤. cv2.boundingRect() í•¨ìˆ˜ëŠ” ì¸ìë¡œ ë°›ì€ contourì— ì™¸ì ‘í•˜ê³  ë˜‘ë°”ë¡œ ì„¸ì›Œì§„ ì§ì‚¬ê°í˜•ì˜ ì¢Œìƒë‹¨ ê¼­ì§“ì  ì¢Œí‘œ(x,y)ì™€ ê°€ë¡œ ì„¸ë¡œ í­ì„ ë¦¬í„´í•©ë‹ˆë‹¤. 

```python
x,y,w,h = cv2.boundingRect(cnt)
cv2.rectangle(img,(x,y),(x+w,y+h),(0,0,255),3)
```



```python
for cont in contours:
    approx = cv2.approxPolyDP(cont,cv2.arcLength(cont,True)*0.02,True)
    vtc=len(approx)
```

: ê²€ì¶œëœ ì™¸ê³½ì„ ë“¤ì„ ë°˜ë³µí•˜ë©´ì„œ ê¼­ì§“ì ì„ êµ¬í•©ë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ ì»¨íˆ¬ì–´ë¥¼ ì§ì„ ìœ¼ë¡œ ê·¼ì‚¬í™”í•˜ì—¬ ì–»ì€ ì§ì„ ì˜ ê°œìˆ˜ë§Œ ê°€ì§€ê³  ë„í˜•ì„ íŒì •ì‹œ ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤. ì˜¤ëª©í•˜ê²Œ ë“¤ì–´ê°„ ë„í˜•ê³¼ ë‚´ë¶€ì— êµ¬ë©ì´ ëš«ë¦° ë„í˜•ì„ ì‚¬ê°í˜•ìœ¼ë¡œ ì¸ì‹í•©ë‹ˆë‹¤.

```python
if cv.isContourConvex(approx): # ê·¼ì‚¬í™”ëœ ì§ì„ ì˜ ê°œìˆ˜ë¥¼ í™œìš©í•˜ì—¬ ì»¨íˆ¬ì–´ ë‚´ë¶€ì˜ ë„í˜•ì´ë¦„ì„ ì¶œë ¥í•©ë‹ˆë‹¤.
        if size ==2:
            setLabel(img_color, "line", cnt)
        elif size == 3:
            setLabel(img_color, "triangle", cnt)
        elif size == 4:
            setLabel(img_color, "rectangle", cnt)
        elif size == 5:
            setLabel(img_color, "pentagon", cnt)
        elif size == 6:
            setLabel(img_color, "hexagon", cnt)
        elif size == 8:
            setLabel(img_color, "octagon", cnt)
        elif size == 10:
            setLabel(img_color, "decagon", cnt)
        else:
            setLabel(img_color, str(size), cnt)
    else:
        setLabel(img_color, str(size), cnt)
```

ì´ë•Œ, `isContourConvex` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë©´ ì˜¤ëª©í•˜ê²Œ ë“¤ì–´ê°„ ê²½ìš°ë¥¼ ì œì™¸ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì•„ë˜ ì‚¬ì§„ì—ì„œ  ì˜¤ëª©í•˜ê²Œ ë“¤ì–´ê°„ ë„í˜•ì„ ì‚¬ê°í˜•ì—ì„œ ì œì™¸ì‹œí‚µë‹ˆë‹¤.

**[ê²°ê³¼]**
![image](https://user-images.githubusercontent.com/86418674/206462925-b8ebc8bd-dd88-4619-bbf4-1ae2240cdde4.png)


# ì „ì²´ì†ŒìŠ¤ì½”ë“œ

 

```python
import cv2 as cv
import os

# ì»¨íˆ¬ì–´ ì˜ì—­ë‚´ì— í…ìŠ¤íŠ¸ ì¶œë ¥
def setLabel(image, str, contour):
    (text_width, text_height), baseline = cv.getTextSize(str, cv.FONT_HERSHEY_SIMPLEX, 0.7, 1)
    
    # ì£¼ì–´ì§„ ë¬¸ìì—´ ì™¸ê³½ì„ ë‘˜ëŸ¬ìŒ€ ìˆ˜ ìˆëŠ” ë°•ìŠ¤ì˜ ë„ˆë¹„ì™€ ë†’ì´ë¥¼ ê³„ì‚°
    x,y,width,height = cv.boundingRect(contour)
    
    # ì»¨íˆ¬ì–´ ì™¸ê³½ì„ ë‘˜ëŸ¬ì‹¸ëŠ” ë°•ìŠ¤ì˜ ì • ì¤‘ì•™ì— í…ìŠ¤íŠ¸ì™€ í…ìŠ¤íŠ¸ ë°•ìŠ¤ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.
    pt_x = x+int((width-text_width)/2)
    pt_y = y+int((height + text_height)/2)
    cv.rectangle(image, (pt_x, pt_y+baseline), (pt_x+text_width, pt_y-text_height), (200,200,200), cv.FILLED)
    cv.putText(image, str, (pt_x, pt_y), cv.FONT_HERSHEY_SIMPLEX, 0.7, (0,0,0), 1, 8)

path = os.path.join('img','shapes.png')
img_color = cv.imread(path, cv.IMREAD_COLOR)

cv.imshow('result', img_color)
#cv.waitKey(0)

img_gray = cv.cvtColor(img_color, cv.COLOR_BGR2GRAY)
cv.imshow('result', img_gray)
#cv.waitKey(0)

ret,img_binary = cv.threshold(img_gray, 127, 255, cv.THRESH_BINARY_INV|cv.THRESH_OTSU)
cv.imshow('result', img_binary)
#cv.waitKey(0)

contours, hierarchy = cv.findContours(img_binary, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE)

for cnt in contours:
    size = len(cnt)
    print(size)

    epsilon = 0.005 * cv.arcLength(cnt, True)
    approx = cv.approxPolyDP(cnt, epsilon, True) # ì»¨íˆ¬ì–´ë¥¼ ì§ì„ ìœ¼ë¡œ ê·¼ì‚¬í™”

    size = len(approx) #ê·¼ì‚¬í™” ì‹œí‚¨ í›„ ì»¨íˆ¬ì–´ë¥¼ êµ¬ì„±í•˜ëŠ” ì„±ë¶„ì˜ ê°œìˆ˜
   
   # ì§ì„ ìœ¼ë¡œ ê·¼ì‚¬í™”ëœ ì»¨íˆ¬ì–´ë¥¼ ì…ë ¥ ì´ë¯¸ì§€ì— ê·¸ë¦°ë‹¤.
    cv.line(img_color, tuple(approx[0][0]), tuple(approx[size-1][0]), (0, 255, 0), 3)
    for k in range(size-1):
        cv.line(img_color, tuple(approx[k][0]), tuple(approx[k+1][0]), (0, 255, 0), 3)

    if cv.isContourConvex(approx): # ê·¼ì‚¬í™”ëœ ì§ì„ ì˜ ê°œìˆ˜ë¥¼ í™œìš©í•˜ì—¬ ì»¨íˆ¬ì–´ ë‚´ë¶€ì˜ ë„í˜•ì´ë¦„ì„ ì¶œë ¥í•©ë‹ˆë‹¤.
        if size ==2:
            setLabel(img_color, "line", cnt)
        elif size == 3:
            setLabel(img_color, "triangle", cnt)
        elif size == 4:
            setLabel(img_color, "rectangle", cnt)
        elif size == 5:
            setLabel(img_color, "pentagon", cnt)
        elif size == 6:
            setLabel(img_color, "hexagon", cnt)
        elif size == 8:
            setLabel(img_color, "octagon", cnt)
        elif size == 10:
            setLabel(img_color, "decagon", cnt)
        else:
            setLabel(img_color, str(size), cnt)
    else:
        setLabel(img_color, str(size), cnt)

cv.imshow('result', img_color)
cv.waitKey(0)
```

# ê²°ê³¼

![image](https://user-images.githubusercontent.com/86418674/206462820-de30f7ec-7e50-4104-9d03-9fd0f48d6100.png)
